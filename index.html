<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoNexus</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><circle cx='20' cy='20' r='18' fill='%237E9AFF' stroke='%23f9d923' stroke-width='3'/><text x='50%' y='55%' text-anchor='middle' fill='%2312161C' font-size='16' font-family='Arial' dy='.3em'>CN</text></svg>" alt="Crypto Nexus Logo" class="logo" style="box-shadow: 0 2px 8px #0002;" />
        <nav class="nav">
          <a href="#" class="nav-item active">
            <span style="display:inline-block;width:18px;height:18px;vertical-align:middle;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"><path d="M3 9l6-6 6 6" fill="none" stroke="#7E9AFF" stroke-width="2"/></svg>
            </span>
            Trade
          </a>
          <a href="#" class="nav-item">
            <span style="display:inline-block;width:18px;height:18px;vertical-align:middle;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="9" cy="9" r="7" fill="none" stroke="#7E9AFF" stroke-width="2"/><text x="9" y="13" text-anchor="middle" font-size="10" fill="#7E9AFF">S</text></svg>
            </span>
            Stats
          </a>
        </nav>
        <div class="user-actions">
          <button class="connect-btn" title="Connect your crypto wallet">Connect Wallet</button>
          <button id="refresh-btn" title="Refresh the Bitcoin price">Refresh Price</button>
          <button id="debug-btn" title="Toggle debug mode">Debug: Off</button>
        </div>
      </div>
    </header>
    <main class="main-content">
      <div id="spinner" class="spinner"></div>
      <h1 id="price">Bitcoin Price: Loading...</h1>
      <div id="three-container" style="width: 100%; height: 400px;"></div>
      <p>CryptoNexus: Your Trading Hub</p>
      <div id="debug-info" style="color: #aaa; font-size: 0.9em;"></div>
    </main>
  </div>
  <script src="./node_modules/three/build/three.min.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const priceElement = document.getElementById('price');
      const refreshBtn = document.getElementById('refresh-btn');
      const debugToggle = document.getElementById('debug-btn');
      const debugInfo = document.getElementById('debug-info');
      const spinner = document.getElementById('spinner');
      let debugMode = false;
      let lastFetchTime = '';
      let lastError = '';
      let lastPrice = 0;
      let lastFrame = 0;

      debugToggle.addEventListener('click', () => {
        debugMode = !debugMode;
        debugToggle.textContent = `Debug: ${debugMode ? 'On' : 'Off'}`;
        if (!debugMode) debugInfo.textContent = '';
      });

      async function updatePrice() {
        try {
          spinner.style.display = 'inline-block';
          const price = await window.api.fetchPrice();
          priceElement.textContent = price;
          lastPrice = price;
          lastFetchTime = new Date().toLocaleTimeString();
          lastError = '';
          if (debugMode) {
            console.log(`[DEBUG] Price fetched: ${price} at ${lastFetchTime}`);
            debugInfo.textContent = `Last price: ${price} | Time: ${lastFetchTime}`;
          }
          return price;
        } catch (error) {
          priceElement.textContent = 'Error';
          lastError = error.message || error;
          if (debugMode) {
            console.error('[DEBUG] Fetch error:', error);
            debugInfo.textContent = `Error: ${lastError} | Time: ${new Date().toLocaleTimeString()}`;
          }
          return 0;
        } finally {
          spinner.style.display = 'none';
        }
      }

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 400, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth * 0.9, 400);
      document.getElementById('three-container').appendChild(renderer.domElement);

      const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
      const material = new THREE.MeshBasicMaterial({ color: 0x7E9AFF });
      const knot = new THREE.Mesh(geometry, material);
      scene.add(knot);
      camera.position.z = 5;

      let lastPriceUpdate = 0;
      let cachedPrice = 0;
      const priceUpdateInterval = 5000; // ms

      async function getThrottledPrice() {
        const now = Date.now();
        if (now - lastPriceUpdate > priceUpdateInterval) {
          cachedPrice = await updatePrice();
          lastPriceUpdate = now;
        }
        return cachedPrice;
      }

      async function animate(frame = 0) {
        requestAnimationFrame(() => animate(frame + 1));
        lastFrame = frame;
        const price = await getThrottledPrice();
        knot.rotation.x += 0.01;
        knot.rotation.y += 0.01;
        knot.scale.setScalar(price / 50000);
        renderer.render(scene, camera);
        if (debugMode && frame % 60 === 0) {
          debugInfo.textContent += ` | Frame: ${frame}`;
        }
      }

      refreshBtn.addEventListener('click', async () => {
        const price = await updatePrice();
        knot.scale.setScalar(price / 50000);
      });

      animate();
    });
  </script>
</body>
</html>